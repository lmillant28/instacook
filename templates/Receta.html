<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Receta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <!-- Flickity CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flickity/2.3.0/flickity.min.css" />
    <!-- Tus estilos -->
    <link rel="stylesheet" href="/css/cabecera.css" />
    <link rel="stylesheet" href="/css/footer.css" />
    <link rel="stylesheet" href="/css/desplegable.css" />
    <link rel="stylesheet" href="/css/imagenE.css" />
    <link rel="stylesheet" href="/css/imagenE.css" />
    <link rel="stylesheet" href="/css/receta.css" />
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js"></script>
    <script type="text/javascript" src="/jquery/desplegable.js"></script>
    <script type="text/javascript" src="/jquery/imagenEquivalencias.js"></script>

</head>

<body>

<!-- Cabecera -->
<header th:replace="Cabecera :: cabecera"></header>

<main>
    <div class="migas" aria-label="Breadcrumb" role="navigation">
        <nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='%236c757d'/%3E%3C/svg%3E&#34;);" aria-label="breadcrumb">
            <ol class="breadcrumb fs-5">
                <li class="breadcrumb-item"><a href="/">Página Principal</a></li>
                <li class="breadcrumb-item">
                    <a th:href="@{/perfilUsu/{usu}(usu=${receta.nombreUsu.nombreUsu})}"
                       th:text="${receta.nombreUsu.nombreUsu}"
                       th:aria-label="'Ver perfil de ' + ${receta.nombreUsu.nombreUsu}"></a>
                </li>
                <li class="breadcrumb-item active" aria-current="page" th:text="${receta.nombre}">Receta</li>
            </ol>
        </nav>
    </div>

    <section class="container my-5" aria-labelledby="receta-titulo">
        <div id="receta-imprimible">
            <!-- Imagen + usuario -->
            <div class="receta-img-bloque">
                <img th:src="@{/imagenes/{img}(img=${receta.imagen})}" class="img-fluid rounded"
                     th:alt="'Foto del plato: ' + ${receta.nombre}" />
                <a th:href="@{/perfilUsu/{usu}(usu=${receta.nombreUsu.nombreUsu})}"
                   th:aria-label="'Ver perfil de ' + ${receta.nombreUsu.nombreUsu}">
                    <p class="receta-usuario" th:text="${receta.nombreUsu.nombreUsu}">usuario</p>
                </a>
            </div>

            <!-- Info receta -->
            <div class="receta-datos-main">
                <div class="d-flex align-items-center justify-content-between">
                    <h2 th:text="${receta.nombre}" class="mb-0" id="receta-titulo">Nombre receta</h2>
                    <i class="bi bi-bookmark-heart fs-3"
                       th:if="${session.usuario != null and session.usuario != receta.nombreUsu.nombreUsu and session.usuario.nombreUsu!='admin'}"
                       onclick="openModal('listaModal')" role="button" tabindex="0" aria-label="Guardar en favoritos"></i>
                </div>
                <div class="mt-4">
                    <h5>Ingredientes:</h5>
                    <p th:text="'Para ' + ${receta.raciones} + ' personas' ">Para X personas</p>
                    <ul>
                        <th:block th:each="ingrediente : ${ingredientes}">
                            <li th:text="${ingrediente.cantidad + ' ' + ingrediente.medida + ' ' + ingrediente.ingrediente.nombre}"></li>
                        </th:block>
                    </ul>
                </div>
                <div class="mt-4">
                    <h5>Modo de preparación:</h5>
                    <ol>
                        <th:block th:each="paso : ${pasos}">
                            <li th:text="${paso}"></li>
                        </th:block>
                    </ol>
                </div>
            </div>

            <!-- Nivel de dificultad y alérgenos -->
            <div class="receta-extra">
                <p><strong>Nivel de dificultad:</strong><br><span th:text="${receta.dificultad}">Fácil</span></p>
                <p><strong>Alérgenos:</strong></p>
                <th:block th:each="alergeno : ${alergenos}">
                    <a th:href="@{/alergenos/{aler}(aler=${alergeno})}" th:aria-label="'Ver recetas con alérgeno ' + ${alergeno}">
                        <img th:src="@{/imagenes/{img}.png(img=${alergeno})}" class="imagA" th:alt="${alergeno}" />
                    </a>
                </th:block>
                <p th:if="${alergenos}==null">Ninguno</p>
            </div>
        </div>

        <!-- Valoración media -->
        <div class="mt-5">
            <button type="button" onclick="openImagen()" aria-label="Abrir tabla de equivalencias">Tabla Equivalencias</button>
            <div th:replace="ModalImagen :: modalImagen"></div>
            <button type="button" onclick="imprimirReceta()" aria-label="Imprimir receta">Imprimir receta</button>
            <h4>Valoración media:</h4>
            <div>
                <span class="text-warning fs-3">
                    <img th:src="@{'/imagenes/reseña-' + ${valoracion} + '.png'}"
                         th:alt="'Valoración media: ' + ${valoracion} + ' estrellas'" id="media">
                </span>
            </div>
        </div>

        <!-- Reseñas -->
        <div class="mt-5">
            <div class="d-flex align-items-center justify-content-between ">
                <h3 id="reseñas-titulo">Reseñas:</h3>
                <i class="bi bi-plus-circle" id="addComent"
                   th:if="${session.usuario != null and existe == null and session.usuario != receta.nombreUsu.nombreUsu and session.usuario.nombreUsu!='admin'}"
                   role="button" tabindex="0" aria-label="Añadir reseña"></i>
            </div>
            <div class="mb-3" th:each="reseña : ${reseñas}">
                <div class="border p-3 rounded">
                    <h5 th:text="${reseña.nombreUsu.nombreUsu}">Usuario</h5>
                    <span class="text-warning">
                        <img th:src="@{'/imagenes/reseña-' + ${reseña.valoracion} + '.png'}"
                             th:alt="'Valoración: ' + ${reseña.valoracion} + ' estrellas'" class="res">
                    </span>
                    <p th:text="${reseña.comentario}">Comentario</p>
                </div>
            </div>
        </div>

        <!-- Formulario reseña -->
        <form th:action="@{/formulario/valorar}" id="formComentario" class="d-none" aria-label="Formulario para valorar receta">
            <div class="mb-3">
                <label for="valoracion" class="form-label">Valoración (1-5):</label>
                <input type="number" id="valoracion" name="valoracion" min="1" max="5" required class="form-control" aria-label="Valoración del 1 al 5">
            </div>
            <div class="mb-3">
                <label for="comentario" class="form-label">Comentario:</label>
                <textarea id="comentario" name="comentario" rows="4" class="form-control" required aria-label="Comentario de la receta"></textarea>
            </div>
            <input type="hidden" id="idReceta" th:value="${receta.idReceta}">
            <button type="submit" class="btn btn-success" aria-label="Enviar reseña">Enviar reseña</button>
        </form>
    </section>

    <div th:replace="ModalListas :: modalListas(${listas}, ${receta}, 'listaModal')" class="modal"></div>
</main>


<!-- Footer -->
<footer th:replace="Footer :: footer"></footer>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function () {
      // Selecciona el botón y el formulario por su id
      const boton = document.getElementById("addComent");
      const formulario = document.getElementById("formComentario");

      // Si existen los elementos en la página...
      if (boton && formulario) {
        // Al hacer click en el botón, muestra el formulario y oculta el botón
        boton.addEventListener("click", () => {
          formulario.classList.remove("d-none"); // Quita la clase que oculta
          boton.classList.add("d-none");         // Oculta el botón
        });

        // Al enviar el formulario de comentario...
        formulario.addEventListener("submit", async (e) => {
          e.preventDefault(); // Previene el envío tradicional

          // Toma los valores del formulario
          const valoracion = parseInt(document.getElementById("valoracion").value);
          const comentario = document.getElementById("comentario").value;
          const idRecetaRaw = document.getElementById("idReceta").value;
          const recetaId = parseInt(idRecetaRaw);

          if (isNaN(recetaId)) {
            alert("ID de receta no válido");
            return;
          }

          // Prepara el objeto con los datos a enviar
          const datos = {
            valoracion,
            comentario,
            recetaId
          };

          console.log("Datos enviados:", datos);

          try {
            // Envío AJAX con fetch (POST, JSON)
            const response = await fetch('/formulario/valorar', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(datos)
            });

            const resultado = await response.text();

            if (response.ok) {
              // Si va bien, recarga la página (para mostrar el nuevo comentario/valoración)
              location.reload();
            } else {
              // Si hay error, lo muestra
              alert("Error al guardar: " + resultado);
            }
          } catch (err) {
            console.error(err);
            alert("Error de conexión con el servidor");
          }
        });
      }
    });
    function imprimirReceta() {
      var contenido = document.getElementById('receta-imprimible').innerHTML;
      var ventana = window.open('', '', 'height=800,width=900');
      ventana.document.write('<html><head><title>Imprimir Receta</title>');

      // Enlaza el CSS de la receta y Bootstrap para impresión
      ventana.document.write('<link rel="stylesheet" href="/css/receta.css" type="text/css" />');
      ventana.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />');

      ventana.document.write('</head><body>');
      ventana.document.write(contenido);
      ventana.document.write('</body></html>');
      ventana.document.close();
      ventana.focus();
      ventana.print();   // Lanza el diálogo de impresión
      ventana.close();   // Cierra la ventana cuando termina
    }



</script>

</body>
</html>