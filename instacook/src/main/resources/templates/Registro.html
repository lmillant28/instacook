<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Perfil Usuario</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <!-- Flickity CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flickity/2.3.0/flickity.min.css" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/additional-methods.min.js"></script>
    <!-- Tus estilos -->
    <link rel="stylesheet" href="/css/cabecera.css" />
    <link rel="stylesheet" href="/css/footer.css" />
    <link rel="stylesheet" href="/css/formulario.css" />
    <style>
        #error ul{
            list-style-type: none;
        }
    </style>

</head>

<body>

<!-- Cabecera -->
<header th:replace="Cabecera :: cabecera"></header>

<main>
    <div class="migas" aria-label="Breadcrumb" role="navigation">
        <nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='%236c757d'/%3E%3C/svg%3E&#34;);" aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="/">Página Principal</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page"><a href="/InicioSesion">Inicio Sesión</a></li>
                <li class="breadcrumb-item active" aria-current="page">Registro</li>
            </ol>
        </nav>
    </div>

    <div class="registro" id="opcionR" aria-labelledby="registro-titulo">
        <h1 id="registro-titulo">Registro</h1>
        <div id="error" style="color: red; margin-bottom: 10px;" role="alert" aria-live="assertive"></div>
        <form id="form-registro" method="post" enctype="multipart/form-data" action="#" aria-label="Formulario de registro">
            <div class="grupo">
                <label for="nombre">Tu nombre:</label>
                <input class="input" type="text" id="nombre" name="nombre" required aria-label="Nombre completo">
            </div>
            <div class="grupo">
                <label for="usuario">Usuario:</label>
                <input class="input" type="text" id="usuario" name="usuario" required aria-label="Nombre de usuario">
            </div>
            <div class="grupo">
                <label for="email">Correo electrónico:</label>
                <input class="input" type="email" id="email" name="email" required autocomplete="email" aria-label="Correo electrónico">
            </div>
            <div class="grupo">
                <label for="password">Contraseña:</label>
                <input class="input" type="password" id="password" name="password" required autocomplete="new-password" aria-label="Contraseña">
            </div>
            <div class="grupo">
                <label for="repeat-password">Repetir contraseña:</label>
                <input class="input" type="password" id="repeat-password" name="repeat-password" required autocomplete="new-password" aria-label="Repetir contraseña">
            </div>
            <div class="cuadroImg">
                <i class="bi bi-card-image" aria-hidden="true"></i>
                <label for="archivo" class="visually-hidden">Foto de perfil</label>
                <input type="file" name="archivo" id="archivo" aria-label="Foto de perfil">
            </div>
            <input class="btn-login" type="submit" value="Registrarse" aria-label="Enviar registro">
        </form>
    </div>
</main>


<!-- Footer -->
<footer th:replace="Footer :: footer"></footer>

<script>
    $(document).ready(function () {

       // Añade un método personalizado para validar que las contraseñas coinciden
        $.validator.addMethod("contraIguales", function (value, element) {
            // value = valor del campo repeat-password
            // Compara con el valor del campo #password
            return value === $('#password').val();
        }, "Las contraseñas no coinciden.");

        // Configura las reglas de validación para el formulario
        $("#form-registro").validate({
            rules: {
                nombre: { required: true }, // Obligatorio
                usuario: {
                    required: true, // Obligatorio
                    remote: { // Valida vía AJAX si el usuario existe ya en el sistema
                        url: "/formulario/verificar-usuario",
                        type: "POST",
                        data: {
                            usuario: function () { return $("#usuario").val(); }
                        }
                    }
                },
                email: {
                    required: true,    // Obligatorio
                    email: true,       // Debe tener formato de correo
                    remote: {          // Comprueba que el email no esté ya registrado
                        url: "/formulario/verificar-email",
                        type: "POST",
                        data: {
                            correo: function () { return $("#email").val(); }
                        }
                    }
                },
                password: {
                    required: true, // Obligatorio
                    minlength: 6    // Mínimo 6 caracteres
                },
                "repeat-password": {
                    required: true,
                    contraIguales: true // Usa la validación personalizada de contraseñas iguales
                },
                archivo: {
                    required: true,
                    extension: "jpg|jpeg|png|gif" // Solo archivos de imagen permitidos
                }
            },
            messages: {
                usuario: { remote: "Este nombre de usuario ya existe." },
                email: { remote: "Este correo ya está registrado." },
                password: { minlength: "La contraseña debe tener al menos 6 caracteres." }
            },
            errorPlacement: function(error, element) {
                // Personaliza dónde y cómo se muestran los errores:
                // En un <ul> dentro de #error, uno por cada campo con error

                let $errorList = $("#error ul");
                if ($errorList.length === 0) {
                    // Si no existe, lo crea
                    $("#error").html("<ul></ul>");
                    $errorList = $("#error ul");
                }
                // Elimina el mensaje de error anterior para este campo (evita duplicados)
                $errorList.find("li[data-error='" + element.attr("name") + "']").remove();
                // Añade el error actual en un <li> con data-error = nombre del campo
                $("<li></li>")
                    .attr("data-error", element.attr("name"))
                    .html(error.text())
                    .appendTo($errorList);
            },
            highlight: function (element) {
                // Añade una clase al campo con error para marcarlo visualmente
                $(element).addClass("is-invalid");
            },
            unhighlight: function (element) {
                // Elimina la clase de error si el campo ya es válido
                $(element).removeClass("is-invalid");
                // También elimina el error de la lista
                let $errorList = $("#error ul");
                $errorList.find("li[data-error='" + $(element).attr("name") + "']").remove();
                // Si ya no quedan errores, vacía #error
                if ($errorList.children().length === 0) {
                    $("#error").html("");
                }
            },
            invalidHandler: function(event, validator) {
                // Se ejecuta si el formulario tiene errores al intentar enviarse
                console.log(" Formulario con errores:");
                console.log(validator.errorList);
                $("#error").html(""); // Limpia antes de mostrar nuevos errores
            },
            submitHandler: function (form) {
                // Si el formulario es válido, gestiona el envío AJAX
                console.log("Enviando formulario...");
                const formData = new FormData(form); // Prepara los datos, incluidos archivos

                $.ajax({
                    url: "/formulario/registro",  // A dónde se envía el formulario
                    type: "POST",
                    data: formData,
                    contentType: false, // Necesario para enviar archivos
                    processData: false, // Idem
                    success: function () {
                        // Si todo va bien, redirige a la página de inicio de sesión
                        window.location.href = "/InicioSesion";
                    },
                    error: function (xhr) {
                        // Si hay error, lo muestra en #error
                        $("#error").html("Error al registrar: " + xhr.responseText);
                    }
                });
            }
        });
    });
</script>
<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


</body>
</html>