<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Perfil Usuario</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <!-- Flickity CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flickity/2.3.0/flickity.min.css" />
    <!-- Tus estilos -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="/css/cabecera.css" />
    <link rel="stylesheet" href="/css/footer.css" />
    <style>

        .migas ol li {
           list-style: none;
        }

        .migas {
           margin-left: 20px;
           margin-top: 50px;
        }
        main{
           margin:auto;
           width: 90%;
           min-height: 69vh;
        }
        .container {
            display: flex;
            align-items: center;
        }
        .filtros {
            display:flex;
            flex-direction:column;
            margin-left: 50px;
        }
        select {
            width: 170px;
            padding: 5px;
            border-radius: 4px;
        }
        .busqueda {
            flex: 1;
            display: flex;
            align-items: center;

        }
        .busqueda input[type="text"] {
            width: 80%;
            padding: 8px 16px;
            border-radius: 16px;
            border: 1px solid #aaa;
            outline: none;
            margin-right: 10px;
        }
        .dificultad {
            display: flex;
            gap: 14px;
            margin-rigth:10px;
        }

        .card-img{
            width:100px;
        }

        .receta a{
            color:black;
            text-decoration:none;
        }
         #resultados { margin-top: 40px;}
        .receta { background: #f7f7f7; margin-bottom: 12px; padding: 10px 20px; border-radius: 8px;}
        .receta span {
            font-size: 13px;
            color: #666;
            margin-left: 105px;
        }
        @media screen and (max-width:680px) and (min-width:250px)  {

            .container {
                display: flex;
                flex-direction: column;
                gap:10px;
            }

            .filtros {
                flex-direction:column;
                margin-left: 0px;
            }

            .busqueda input[type="text"] {
                width: 100%;
                padding: 8px 16px;
                margin-right: 0px;
            }

            .dificultad{
                margin-top:10px;
                margin-bottom:10px;
            }

        }
    </style>

</head>

<body>

<!-- Cabecera -->
<header th:replace="Cabecera :: cabecera"></header>

<main>
    <div class="migas" aria-label="Breadcrumb" role="navigation">
        <nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='%236c757d'/%3E%3C/svg%3E&#34;);" aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="/">Página Principal</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Buscador</li>
            </ol>
        </nav>
    </div>
    <div class="container" aria-labelledby="titulo-busqueda">
        <h1 id="titulo-busqueda" class="visually-hidden">Buscador de recetas</h1>
        <div class="busqueda" role="search" aria-label="Formulario de búsqueda de recetas">
            <label for="busqueda" class="visually-hidden">Buscar recetas por nombre:</label>
            <input type="text" placeholder="postres" id="busqueda" name="busqueda" aria-label="Buscar recetas por nombre">
        </div>
        <div class="dificultad" aria-labelledby="leyenda-dificultad">
            <span id="leyenda-dificultad" class="visually-hidden">Filtrar por dificultad:</span>
            <label for="dif-facil"><input id="dif-facil" type="checkbox" name="dificultad" value="Fácil"> Fácil</label>
            <label for="dif-media"><input id="dif-media" type="checkbox" name="dificultad" value="Media"> Media</label>
            <label for="dif-alta"><input id="dif-alta" type="checkbox" name="dificultad" value="Alta"> Alta</label>
        </div>
        <div class="filtros">
            <label for="categoria" class="visually-hidden">Filtrar por categoría:</label>
            <select id="categoria" name="categoria" aria-label="Filtrar por categoría">
                <option value="">Seleccione categoría</option>
                <th:block th:each="cate:${categorias}">
                    <option th:value="${cate.nombre}" th:text="${cate.nombre}"></option>
                </th:block>
            </select>
        </div>
    </div>
    <div id="resultados" aria-live="polite" aria-atomic="true"></div>
</main>

<!-- Footer -->
<footer th:replace="Footer :: footer"></footer>
<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(function () {
        // Selecciona elementos del DOM
        const $inputBusqueda = $('#busqueda');                   // Input de búsqueda por nombre
        const $selectCategoria = $('#categoria');                // Select de categorías
        const $checkboxesDificultad = $('input[name="dificultad"]'); // Checkboxes de dificultad
        const $resultados = $('#resultados');                    // Contenedor donde se mostrarán los resultados

        // Función que hace la petición AJAX para buscar recetas
        function buscarRecetas() {
            // Toma los valores de los filtros actuales
            const nombre = $inputBusqueda.val().trim();
            const categorias = $selectCategoria.val();
            const dificultadesSeleccionadas = $checkboxesDificultad
                .filter(':checked')
                .map(function(){ return this.value; }).get();

            // Construye la query string de parámetros solo con los valores presentes
            let params = [];
            if (nombre) params.push('nombre=' + encodeURIComponent(nombre));
            if (categorias && categorias !== "-") params.push('categorias=' + encodeURIComponent(categorias));
            dificultadesSeleccionadas.forEach(function(dif) {
                params.push('dificultad=' + encodeURIComponent(dif));
            });

            // Construye la URL final con los parámetros
            let url = '/busqueda/buscar' + (params.length ? '?' + params.join('&') : '');

            // Realiza la petición AJAX (GET) al backend
            $.ajax({
                url: url,
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    // Si va bien, muestra las recetas
                    pintarRecetas(data);
                },
                error: function() {
                    // Si falla, muestra mensaje de error
                    $resultados.html("<p>Error cargando las recetas.</p>");
                }
            });
        }

        // Función para pintar recetas en el DOM
        function pintarRecetas(recetas) {
            if (!recetas || recetas.length === 0) {
                $resultados.html("<p>No se encontraron recetas.</p>");
                return;
            }
            // Mapea cada receta a un bloque HTML (tarjeta/preview)
            $resultados.html(recetas.map(function(receta) {
               return `
                    <div class="receta">
                        <a href="/receta/${receta.idReceta}">
                          <img class="card-img" src="/imagenes/${receta.imagen}" alt="${receta.imagen} imagen" />
                        </a>
                        <strong><a href="/receta/${receta.idReceta}">${receta.nombre}</a></strong><br>
                        <span>${receta.categorias} - ${receta.dificultad} - Valoración media: ${receta.media ? receta.media.toFixed(1) : '0.0'}</span>
                    </div>
                `;
            }).join(''));
        }

        // Eventos: cada vez que cambias algo en los filtros, lanza la búsqueda automáticamente
        $inputBusqueda.on('input', buscarRecetas);    // Al escribir en el input
        $selectCategoria.on('change', buscarRecetas); // Al cambiar de categoría
        $checkboxesDificultad.on('change', buscarRecetas); // Al marcar/desmarcar dificultades

        // Primera carga: muestra todas las recetas o los resultados iniciales al abrir la página
        buscarRecetas();
    });

</script>

</body>
</html>