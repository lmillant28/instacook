<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Perfil Usuario</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <!-- Flickity CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flickity/2.3.0/flickity.min.css" />
    <!-- Tus estilos -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="/css/cabecera.css" />
    <link rel="stylesheet" href="/css/footer.css" />
    <link rel="stylesheet" href="/css/nuevaR.css" />
    <link rel="stylesheet" href="/css/imagenE.css" />
    <script type="text/javascript" src="/jquery/imagenEquivalencias.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(function () {
            // Selección de los elementos del DOM que vamos a usar
            const selectIngrediente = document.getElementById('ingredientes');
            const cantidadInput = document.getElementById('cantidad');
            const btnAnadir = document.querySelector('.btn-anadir');
            const lista = document.getElementById('lista-ingredientes-ul');
            const inputHidden = document.getElementById('ingredientesJson');

            // Array donde se almacenan los ingredientes añadidos a la receta
            const ingredientesPorReceta = [];

            // Inicializa el select de ingredientes con Select2 (mejora el diseño y funcionalidad de búsqueda)
            $('#ingredientes').select2({
                placeholder: "Buscar ingrediente...",
                width: '100%'
            });

            // Actualiza el input oculto con el array serializado en JSON cada vez que se añada o elimine algo
            function actualizarInputHidden() {
                inputHidden.value = JSON.stringify(ingredientesPorReceta);
            }

            // Al pulsar el botón de añadir ingrediente...
            btnAnadir.addEventListener('click', function() {
                const idIngrediente = selectIngrediente.value;
                const nombreIngrediente = selectIngrediente.options[selectIngrediente.selectedIndex].text;
                // Busca el input radio de unidad de medición seleccionado
                const check = document.querySelector('input[name="medicion"]:checked');
                const unidad = check.value;
                const cantidad = cantidadInput.value;

                // Validación: no permite añadir si falta cantidad o unidad
                if (!cantidad || unidad.length === 0) {
                    alert('Selecciona al menos una unidad y pon una cantidad.');
                    return;
                }

                // Identificador único para buscar luego el ingrediente en el array
                const identificador = `${idIngrediente}-${unidad}-${cantidad}`;

                // Añade el ingrediente al array
                ingredientesPorReceta.push({
                    idIngrediente: idIngrediente,
                    cantidad: cantidad,
                    medida: unidad // (ojo: abajo hay un pequeño error con el nombre de la propiedad)
                });

                // Crea el <li> visual para la lista de ingredientes
                const li = document.createElement('li');
                li.textContent = `${cantidad} ${unidad} de ${nombreIngrediente}`;
                li.setAttribute('data-identificador', identificador);
                li.style.cursor = "pointer";
                li.title = "Haz clic para eliminar";
                lista.appendChild(li);

                // Limpia los campos del formulario para añadir más ingredientes cómodamente
                cantidadInput.value = '';
                selectIngrediente.value= '';
                check.checked = false;

                // Actualiza el input oculto
                actualizarInputHidden();
            });

            // Permite eliminar ingredientes haciendo click en ellos en la lista
            lista.addEventListener('click', function(e) {
                if (e.target.tagName === 'LI') {
                    const identificador = e.target.getAttribute('data-identificador');
                    // Extrae los datos del identificador
                    const [idIngrediente, unidad, cantidad] = identificador.split('-');
                    // Busca el índice en el array
                    const index = ingredientesPorReceta.findIndex(obj =>
                        obj.idIngrediente === idIngrediente &&
                        obj.cantidad === cantidad &&
                        obj.unidad === unidad
                    );
                    // Si lo encuentra, lo elimina del array
                    if (index !== -1) {
                        ingredientesPorReceta.splice(index, 1);
                    }
                    // Quita el <li> del DOM
                    e.target.remove();
                    // Actualiza el input oculto
                    actualizarInputHidden();
                }
            });
        });

    </script>
</head>

<body>

<!-- Cabecera -->
<header th:replace="Cabecera :: cabecera"></header>

<main>
    <div class="migas" aria-label="Breadcrumb" role="navigation">
        <nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='%236c757d'/%3E%3C/svg%3E&#34;);" aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="/">Página Principal</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Buscador</li>
            </ol>
        </nav>
    </div>
    <form class="publicacion-form" th:action="@{/perfil/guardarReceta}" method="post" enctype="multipart/form-data" aria-label="Formulario para agregar nueva receta">
        <h2 id="titulo-agregar-receta">Agregar Publicación</h2>

        <div class="form-section">
            <label for="nombre">Nombre:</label>
            <input type="text" id="nombre" name="nombre" required aria-label="Nombre de la receta">
            <label for="archivo">Imagen:</label>
            <input type="file" name="archivo" id="archivo" aria-label="Imagen de la receta">
            <label for="raciones">Raciones:</label>
            <input type="number" id="raciones" name="raciones" required min="1" aria-label="Número de raciones">
        </div>

        <div class="form-row">
            <div class="form-section">
                <label for="categorias">Categorías:</label>
                <select id="categorias" name="categorias" multiple aria-label="Selecciona una o más categorías">
                    <th:block  th:each="categoria : ${categorias}">
                        <option  th:value="${categoria.idCategoria}" th:text="${categoria.nombre}">Sopas</option>
                    </th:block>
                </select>
            </div>
        </div>

        <div class="form-section" aria-labelledby="dificultad-label">
            <span id="dificultad-label" class="visually-hidden">Dificultad de la receta</span>
            <label>Dificultad:</label>
            <div class="dificultad-group">
                <label for="dif-facil"><input id="dif-facil" type="radio" name="dificultad" value="Fácil" required> Fácil</label>
                <label for="dif-medio"><input id="dif-medio" type="radio" name="dificultad" value="Medio"> Medio</label>
                <label for="dif-dificil"><input id="dif-dificil" type="radio" name="dificultad" value="Difícil"> Difícil</label>
            </div>
        </div>

        <div class="ingredientes-wrapper">
            <div class="ingredientes-box">
                <label for="ingredientes">Ingredientes:</label>
                <select id="ingredientes" name="ingredientes" aria-label="Selecciona ingrediente">
                    <th:block  th:each="ingrediente : ${ingredientes}">
                        <option th:value="${ingrediente.idIngrediente}" th:text="${ingrediente.nombre}"></option>
                    </th:block>
                </select>

                <div class="medicion-group" aria-labelledby="medicion-label">
                    <span id="medicion-label" class="visually-hidden">Unidad de medida</span>
                    <label>Medición:</label>
                    <th:block  th:each="unidad : ${unidades}">
                        <label><input type="checkbox" name="medicion" th:value="${unidad}" th:text="${unidad}"></label>
                    </th:block>
                </div>
                <label for="cantidad">Cantidad:</label>
                <input type="number" id="cantidad" name="cantidad" min="1" aria-label="Cantidad del ingrediente">
                <button type="button" class="btn-anadir" aria-label="Añadir ingrediente">Añadir</button>
            </div>
            <div class="lista-ingredientes">
                <button type="button" onclick="openImagen()" aria-label="Ver tabla de equivalencias">Ver tabla Equivalencias</button>
                <div th:replace="ModalImagen :: modalImagen"></div>
                <label for="lista-ingredientes-ul">Lista de ingredientes</label>
                <ul id="lista-ingredientes-ul" aria-live="polite" aria-atomic="true"></ul>
            </div>
            <input type="hidden" name="ingredientesJson" id="ingredientesJson">
        </div>

        <div class="preparacion-wrapper">
            <label for="modo-prep">Modo de preparación:</label>
            <textarea id="modo-prep" name="modo-prep" rows="8" required aria-label="Modo de preparación"></textarea>
        </div>

        <div class="btn-publicar-wrapper">
            <button type="submit" class="btn-publicar" aria-label="Publicar receta">Publicar</button>
        </div>
    </form>
</main>

<!-- Footer -->
<footer th:replace="Footer :: footer"></footer>
<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


</body>
</html>